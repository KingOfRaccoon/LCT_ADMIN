{
  "id": "avito-cart-demo-subflow",
  "name": "Авито — Корзина с Subflow",
  "description": "Демонстрация использования subflow для переиспользуемых частей workflow",
  "slug": "avito-cart-subflow",
  "variableSchemas": {
    "cart_response": {
      "type": "object",
      "schema": {
        "id": "number",
        "user_id": "number",
        "shop_groups": "array",
        "total_amount": "number",
        "selected_items_count": "number",
        "total_items_count": "number"
      }
    },
    "store": {
      "type": "object",
      "schema": {
        "id": "number",
        "name": "string",
        "rating": "number"
      }
    },
    "ui": {
      "type": "object",
      "schema": {
        "ready": "boolean",
        "notifications": "object"
      }
    },
    "state": {
      "type": "object",
      "schema": {
        "empty": "boolean",
        "loading": "boolean"
      }
    },
    "selected_item_id": {
      "type": "number",
      "schema": null
    },
    "quantity_change": {
      "type": "number",
      "schema": null
    },
    "suggested_products": {
      "type": "array",
      "schema": []
    },
    "onboarding_result": {
      "type": "object",
      "schema": {
        "completed": "boolean",
        "skipped": "boolean"
      }
    },
    "onboarding_error": {
      "type": "string",
      "schema": null
    }
  },
  "initialContext": {
    "cart_response": {
      "id": 3,
      "user_id": 4,
      "shop_groups": [],
      "total_amount": 0,
      "selected_items_count": 0,
      "total_items_count": 0
    },
    "store": {
      "id": 14,
      "name": "Екатерина Батюшкова",
      "rating": 5.0
    },
    "selected_advertisement_id": 8,
    "add_to_cart_response": null,
    "selected_item_id": null,
    "quantity_change": 1,
    "suggested_products": [
      {
        "id": 10,
        "name": "Apple Watch 10 256Gb",
        "price": 26591,
        "image": "https://via.placeholder.com/80"
      },
      {
        "id": 11,
        "name": "iPhone 16 Pro 256Gb",
        "price": 99990,
        "image": "https://via.placeholder.com/80"
      }
    ],
    "ui": {
      "ready": false,
      "notifications": {
        "type": null,
        "message": null,
        "actionLabel": null,
        "actionEvent": null
      }
    },
    "state": {
      "empty": true,
      "loading": false
    },
    "onboarding_result": null,
    "onboarding_error": null,
    "user_name": "Гость"
  },
  "nodes": [
    {
      "id": "68f3f2e3f89a105e6505c4b2",
      "label": "Онбординг пользователя",
      "type": "subflow",
      "state_type": "subflow",
      "start": true,
      "name": "OnboardingFlow",
      "description": "Приветственный onboarding для новых пользователей",
      "expressions": [
        {
          "variable": "onboarding_result",
          "subflow_workflow_id": "onboarding-flow",
          "input_mapping": {
            "user_id": "cart_response.user_id",
            "store_name": "store.name"
          },
          "output_mapping": {
            "completed": "onboarding_result.completed",
            "user_preferences": "user_name"
          },
          "dependent_variables": ["cart_response", "store"],
          "error_variable": "onboarding_error"
        }
      ],
      "transitions": [
        {
          "variable": "onboarding_result",
          "case": null,
          "state_id": "fetch-cart-items"
        },
        {
          "variable": "onboarding_error",
          "case": null,
          "state_id": "fetch-cart-items"
        }
      ],
      "edges": []
    },
    {
      "id": "fetch-cart-items",
      "label": "Загрузка товаров корзины",
      "type": "integration",
      "state_type": "integration",
      "start": false,
      "description": "Загружает корзину с товарами пользователя",
      "expressions": [
        {
          "variable": "cart_response",
          "url": "https://sandkittens.me/backservices/api/carts/3/with-advertisements",
          "params": {},
          "method": "get",
          "metadata": {
            "description": "Получает корзину с ID 3 и все товары в ней",
            "category": "data",
            "tags": ["integration", "api", "cart", "advertisements"]
          }
        }
      ],
      "transitions": [
        {
          "variable": "cart_response",
          "case": null,
          "state_id": "cart-main"
        }
      ],
      "edges": []
    },
    {
      "id": "cart-main",
      "label": "Корзина",
      "type": "screen",
      "screenId": "screen-cart-main",
      "start": false,
      "edges": [
        {
          "id": "edge-add-to-cart",
          "label": "Добавить товар",
          "event": "addToCart",
          "keepInputs": true,
          "summary": "Добавление товара в корзину",
          "target": "add-to-cart-integration",
          "contextPatch": {}
        },
        {
          "id": "edge-increase-quantity",
          "label": "Увеличить количество",
          "event": "increaseQuantity",
          "keepInputs": true,
          "summary": "Увеличение количества товара",
          "target": "increase-quantity-integration",
          "contextPatch": {}
        },
        {
          "id": "edge-decrease-quantity",
          "label": "Уменьшить количество",
          "event": "decreaseQuantity",
          "keepInputs": true,
          "summary": "Уменьшение количества товара",
          "target": "decrease-quantity-integration",
          "contextPatch": {}
        },
        {
          "id": "edge-remove-item",
          "label": "Удалить товар",
          "event": "removeItem",
          "keepInputs": true,
          "summary": "Удаление товара из корзины",
          "target": "remove-item-integration",
          "contextPatch": {}
        },
        {
          "id": "edge-toggle-focus",
          "label": "Снять/вернуть фокус",
          "event": "toggleFocus",
          "keepInputs": true,
          "summary": "Переключение участия товара в расчете",
          "target": "toggle-focus-integration",
          "contextPatch": {}
        },
        {
          "id": "edge-checkout",
          "label": "Оформить заказ",
          "event": "checkout",
          "keepInputs": true,
          "summary": "Переход к оформлению заказа",
          "target": "checkout-screen",
          "contextPatch": {}
        }
      ]
    },
    {
      "id": "add-to-cart-integration",
      "label": "Добавление товара в корзину",
      "type": "integration",
      "state_type": "integration",
      "start": false,
      "description": "POST-запрос для добавления товара в корзину",
      "expressions": [
        {
          "variable": "add_to_cart_response",
          "url": "https://sandkittens.me/backservices/api/carts/add-advertisement",
          "params": {},
          "method": "post",
          "body": {
            "cart_id": 3,
            "advertisement_id": 9
          },
          "metadata": {
            "description": "Добавляет товар в корзину пользователя",
            "category": "data",
            "tags": ["integration", "api", "cart", "post"]
          }
        }
      ],
      "transitions": [
        {
          "variable": "add_to_cart_response",
          "case": null,
          "state_id": "fetch-cart-items"
        }
      ],
      "edges": []
    },
    {
      "id": "increase-quantity-integration",
      "label": "Увеличение количества",
      "type": "integration",
      "state_type": "integration",
      "start": false,
      "description": "PATCH-запрос для увеличения количества товара в корзине",
      "expressions": [
        {
          "variable": "add_to_cart_response",
          "url": "https://sandkittens.me/backservices/api/carts/3/items/${selected_item_id}",
          "params": {},
          "method": "patch",
          "body": {
            "quantity": "${quantity_change + 1}"
          },
          "metadata": {
            "description": "Увеличивает количество товара на 1",
            "category": "data",
            "tags": ["integration", "api", "cart", "quantity"]
          }
        }
      ],
      "transitions": [
        {
          "variable": "add_to_cart_response",
          "case": null,
          "state_id": "fetch-cart-items"
        }
      ],
      "edges": []
    },
    {
      "id": "decrease-quantity-integration",
      "label": "Уменьшение количества",
      "type": "integration",
      "state_type": "integration",
      "start": false,
      "description": "PATCH-запрос для уменьшения количества товара в корзине",
      "expressions": [
        {
          "variable": "add_to_cart_response",
          "url": "https://sandkittens.me/backservices/api/carts/3/items/${selected_item_id}",
          "params": {},
          "method": "patch",
          "body": {
            "quantity": "${quantity_change - 1}"
          },
          "metadata": {
            "description": "Уменьшает количество товара на 1",
            "category": "data",
            "tags": ["integration", "api", "cart", "quantity"]
          }
        }
      ],
      "transitions": [
        {
          "variable": "add_to_cart_response",
          "case": null,
          "state_id": "fetch-cart-items"
        }
      ],
      "edges": []
    },
    {
      "id": "remove-item-integration",
      "label": "Удаление товара",
      "type": "integration",
      "state_type": "integration",
      "start": false,
      "description": "DELETE-запрос для удаления товара из корзины",
      "expressions": [
        {
          "variable": "add_to_cart_response",
          "url": "https://sandkittens.me/backservices/api/carts/3/advertisements/${selected_item_id}",
          "params": {},
          "method": "delete",
          "metadata": {
            "description": "Удаляет товар из корзины",
            "category": "data",
            "tags": ["integration", "api", "cart", "delete"]
          }
        }
      ],
      "transitions": [
        {
          "variable": "add_to_cart_response",
          "case": null,
          "state_id": "fetch-cart-items"
        }
      ],
      "edges": []
    },
    {
      "id": "toggle-focus-integration",
      "label": "Переключение фокуса",
      "type": "integration",
      "state_type": "integration",
      "start": false,
      "description": "PATCH-запрос для снятия/возврата фокуса (участие в расчете)",
      "expressions": [
        {
          "variable": "add_to_cart_response",
          "url": "https://sandkittens.me/backservices/api/carts/3/items/${selected_item_id}",
          "params": {},
          "method": "patch",
          "body": {
            "selected": "${!product.selected}"
          },
          "metadata": {
            "description": "Переключает участие товара в расчете стоимости",
            "category": "data",
            "tags": ["integration", "api", "cart", "focus"]
          }
        }
      ],
      "transitions": [
        {
          "variable": "add_to_cart_response",
          "case": null,
          "state_id": "fetch-cart-items"
        }
      ],
      "edges": []
    },
    {
      "id": "checkout-screen",
      "label": "Оформление заказа",
      "type": "screen",
      "screenId": "screen-checkout",
      "edges": []
    }
  ],
  "subflows": {
    "onboarding-flow": {
      "id": "onboarding-flow",
      "name": "Онбординг",
      "description": "Двухэкранный онбординг для новых пользователей",
      "input_variables": ["user_id", "store_name"],
      "output_variables": ["completed", "user_preferences"],
      "nodes": [
        {
          "id": "onboarding-screen-1",
          "label": "Экран приветствия",
          "type": "screen",
          "screenId": "screen-onboarding-1",
          "start": true,
          "edges": [
            {
              "id": "edge-to-screen-2",
              "label": "Продолжить",
              "event": "continueOnboarding",
              "keepInputs": true,
              "summary": "Переход на второй экран онбординга",
              "target": "onboarding-screen-2",
              "contextPatch": {}
            }
          ]
        },
        {
          "id": "onboarding-screen-2",
          "label": "Экран завершения",
          "type": "screen",
          "screenId": "screen-onboarding-2",
          "start": false,
          "edges": [
            {
              "id": "edge-complete-onboarding",
              "label": "Завершить онбординг",
              "event": "completeOnboarding",
              "keepInputs": true,
              "summary": "Выход из subflow с результатом",
              "target": "exit",
              "contextPatch": {
                "completed": true,
                "user_preferences": "Опытный пользователь"
              }
            },
            {
              "id": "edge-skip-onboarding",
              "label": "Пропустить",
              "event": "skipOnboarding",
              "keepInputs": true,
              "summary": "Выход из subflow без завершения",
              "target": "exit",
              "contextPatch": {
                "completed": false,
                "user_preferences": "Гость"
              }
            }
          ]
        }
      ],
      "screens": {
        "screen-onboarding-1": {
          "id": "screen-onboarding-1",
          "type": "Screen",
          "name": "Добро пожаловать",
          "style": {
            "display": "flex",
            "flexDirection": "column",
            "minHeight": "720px",
            "backgroundColor": "#ffffff",
            "borderRadius": "12px",
            "padding": "32px"
          },
          "sections": {
            "body": {
              "id": "section-onboarding-1-body",
              "type": "Section",
              "properties": {
                "slot": "body",
                "padding": 0,
                "spacing": 24,
                "alignItems": "center",
                "justifyContent": "center"
              },
              "style": {
                "flex": "1 1 auto"
              },
              "children": [
                {
                  "id": "image-welcome",
                  "type": "image",
                  "properties": {
                    "src": "https://via.placeholder.com/200x200/8B5CF6/ffffff?text=👋",
                    "alt": "Добро пожаловать"
                  },
                  "style": {
                    "width": "200px",
                    "height": "200px",
                    "borderRadius": "50%",
                    "objectFit": "cover"
                  }
                },
                {
                  "id": "text-welcome-title",
                  "type": "text",
                  "properties": {
                    "content": "Добро пожаловать!",
                    "variant": "heading"
                  },
                  "style": {
                    "fontSize": "32px",
                    "fontWeight": 700,
                    "color": "#2F3034",
                    "textAlign": "center"
                  }
                },
                {
                  "id": "text-welcome-subtitle",
                  "type": "text",
                  "properties": {
                    "content": {
                      "reference": "Магазин ${store_name} рад приветствовать вас!",
                      "value": "Магазин рад приветствовать вас!"
                    },
                    "variant": "body"
                  },
                  "style": {
                    "fontSize": "17px",
                    "fontWeight": 400,
                    "color": "#8E8E93",
                    "textAlign": "center",
                    "maxWidth": "400px"
                  }
                },
                {
                  "id": "text-welcome-description",
                  "type": "text",
                  "properties": {
                    "content": "Давайте познакомимся и настроим ваш профиль для лучшего опыта покупок",
                    "variant": "body"
                  },
                  "style": {
                    "fontSize": "15px",
                    "fontWeight": 400,
                    "color": "#8E8E93",
                    "textAlign": "center",
                    "maxWidth": "400px"
                  }
                },
                {
                  "id": "button-continue",
                  "type": "button",
                  "properties": {
                    "text": "Продолжить",
                    "variant": "primary",
                    "event": "continueOnboarding"
                  },
                  "style": {
                    "marginTop": "24px",
                    "padding": "16px 48px",
                    "borderRadius": "16px",
                    "backgroundColor": "#8B5CF6",
                    "fontSize": "17px",
                    "fontWeight": 600,
                    "color": "#ffffff",
                    "border": "none",
                    "cursor": "pointer"
                  }
                }
              ]
            }
          }
        },
        "screen-onboarding-2": {
          "id": "screen-onboarding-2",
          "type": "Screen",
          "name": "Настройка профиля",
          "style": {
            "display": "flex",
            "flexDirection": "column",
            "minHeight": "720px",
            "backgroundColor": "#ffffff",
            "borderRadius": "12px",
            "padding": "32px"
          },
          "sections": {
            "body": {
              "id": "section-onboarding-2-body",
              "type": "Section",
              "properties": {
                "slot": "body",
                "padding": 0,
                "spacing": 24,
                "alignItems": "center",
                "justifyContent": "center"
              },
              "style": {
                "flex": "1 1 auto"
              },
              "children": [
                {
                  "id": "image-profile",
                  "type": "image",
                  "properties": {
                    "src": "https://via.placeholder.com/200x200/0A74F0/ffffff?text=⚙️",
                    "alt": "Настройка профиля"
                  },
                  "style": {
                    "width": "200px",
                    "height": "200px",
                    "borderRadius": "50%",
                    "objectFit": "cover"
                  }
                },
                {
                  "id": "text-profile-title",
                  "type": "text",
                  "properties": {
                    "content": "Настройте свой профиль",
                    "variant": "heading"
                  },
                  "style": {
                    "fontSize": "32px",
                    "fontWeight": 700,
                    "color": "#2F3034",
                    "textAlign": "center"
                  }
                },
                {
                  "id": "text-profile-description",
                  "type": "text",
                  "properties": {
                    "content": "Расскажите нам о себе, чтобы мы могли предложить лучшие товары",
                    "variant": "body"
                  },
                  "style": {
                    "fontSize": "15px",
                    "fontWeight": 400,
                    "color": "#8E8E93",
                    "textAlign": "center",
                    "maxWidth": "400px"
                  }
                },
                {
                  "id": "column-actions",
                  "type": "column",
                  "properties": {
                    "spacing": 12,
                    "alignItems": "center"
                  },
                  "style": {
                    "marginTop": "24px"
                  },
                  "children": [
                    {
                      "id": "button-complete",
                      "type": "button",
                      "properties": {
                        "text": "Завершить настройку",
                        "variant": "primary",
                        "event": "completeOnboarding"
                      },
                      "style": {
                        "padding": "16px 48px",
                        "borderRadius": "16px",
                        "backgroundColor": "#8B5CF6",
                        "fontSize": "17px",
                        "fontWeight": 600,
                        "color": "#ffffff",
                        "border": "none",
                        "cursor": "pointer"
                      }
                    },
                    {
                      "id": "button-skip",
                      "type": "button",
                      "properties": {
                        "text": "Пропустить",
                        "variant": "link",
                        "event": "skipOnboarding"
                      },
                      "style": {
                        "padding": "12px 24px",
                        "fontSize": "15px",
                        "fontWeight": 400,
                        "color": "#8E8E93",
                        "background": "transparent",
                        "border": "none",
                        "cursor": "pointer",
                        "textDecoration": "underline"
                      }
                    }
                  ]
                }
              ]
            }
          }
        }
      }
    }
  },
  "screens": {
    "screen-cart-main": {
      "id": "screen-cart-main",
      "type": "Screen",
      "name": "Корзина",
      "style": {
        "display": "flex",
        "flexDirection": "column",
        "minHeight": "720px",
        "backgroundColor": "#ffffff",
        "borderRadius": "12px",
        "padding": "0px"
      },
      "sections": {
        "header": {
          "id": "section-cart-header",
          "type": "Section",
          "properties": {
            "slot": "header",
            "padding": 0,
            "spacing": 0,
            "background": "#ffffff"
          },
          "style": {
            "borderBottom": "none"
          },
          "children": [
            {
              "id": "row-navbar",
              "type": "row",
              "properties": {
                "spacing": 12,
                "alignItems": "center",
                "justifyContent": "space-between",
                "padding": 16
              },
              "style": {
                "height": "48px",
                "borderBottom": "1px solid #E5E5E5"
              },
              "children": [
                {
                  "id": "button-back",
                  "type": "button",
                  "properties": {
                    "text": "←",
                    "variant": "link",
                    "event": "goBack"
                  },
                  "style": {
                    "fontSize": "24px",
                    "fontWeight": 400,
                    "color": "#0A74F0",
                    "background": "transparent",
                    "border": "none",
                    "cursor": "pointer",
                    "padding": "0",
                    "width": "40px",
                    "textAlign": "left"
                  }
                },
                {
                  "id": "text-cart-title",
                  "type": "text",
                  "properties": {
                    "content": {
                      "reference": "Корзина — ${user_name}",
                      "value": "Корзина"
                    },
                    "variant": "heading"
                  },
                  "style": {
                    "fontSize": "17px",
                    "fontWeight": 600,
                    "color": "#2F3034",
                    "flex": "1",
                    "textAlign": "center"
                  }
                },
                {
                  "id": "spacer-right",
                  "type": "text",
                  "properties": {
                    "content": "",
                    "variant": "body"
                  },
                  "style": {
                    "width": "40px"
                  }
                }
              ]
            }
          ]
        },
        "body": {
          "id": "section-cart-body",
          "type": "Section",
          "properties": {
            "slot": "body",
            "padding": 16,
            "spacing": 16,
            "alignItems": "stretch"
          },
          "style": {
            "flex": "1 1 auto",
            "overflowY": "auto"
          },
          "children": [
            {
              "id": "text-cart-placeholder",
              "type": "text",
              "properties": {
                "content": "Здесь будет отображаться содержимое корзины после завершения онбординга",
                "variant": "body"
              },
              "style": {
                "fontSize": "15px",
                "fontWeight": 400,
                "color": "#8E8E93",
                "textAlign": "center",
                "padding": "64px 32px"
              }
            }
          ]
        }
      }
    },
    "screen-checkout": {
      "id": "screen-checkout",
      "type": "Screen",
      "name": "Оформление",
      "style": {
        "display": "flex",
        "flexDirection": "column",
        "minHeight": "720px",
        "backgroundColor": "#ffffff",
        "borderRadius": "12px",
        "padding": "0px"
      },
      "sections": {
        "body": {
          "id": "section-checkout-body",
          "type": "Section",
          "properties": {
            "slot": "body",
            "padding": 32,
            "spacing": 16,
            "alignItems": "stretch"
          },
          "style": {
            "flex": "1 1 auto"
          },
          "children": [
            {
              "id": "text-checkout-title",
              "type": "text",
              "properties": {
                "content": "Оформление заказа",
                "variant": "heading"
              },
              "style": {
                "fontSize": "24px",
                "fontWeight": 700,
                "color": "#2F3034"
              }
            },
            {
              "id": "text-checkout-placeholder",
              "type": "text",
              "properties": {
                "content": "Форма оформления появится здесь",
                "variant": "body"
              },
              "style": {
                "fontSize": "15px",
                "color": "#8E8E93"
              }
            }
          ]
        }
      }
    }
  }
}
